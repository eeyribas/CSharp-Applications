using Microsoft.Win32;
using Newtonsoft.Json;
using SuperWebSocket;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace Custom3DChartDrawing
{
    public partial class Form1 : Form
    {
        private string fileName = Path.GetFileName(Process.GetCurrentProcess().MainModule.FileName);
        private static WebSocketServer webSocketServer;
        private Dictionary<string, WebSocketSession> webSocketSessions;

        public Form1()
        {
            InitializeComponent();

            this.StartPosition = FormStartPosition.CenterScreen;

            webSocketSessions = new Dictionary<string, WebSocketSession>();
            webSocketServer = new WebSocketServer();
            webSocketServer.Setup(3435);
            webSocketServer.NewSessionConnected += WsServer_NewSessionConnected;
            webSocketServer.Start();

            setFormConfig();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            string path = Directory.GetCurrentDirectory() + @"\WebPage\Chart2.html";
            webBrowser1.Url = new Uri(path);
        }

        private void button1_Click(object sender, EventArgs e)
        {
            Task task = new Task(() =>
            {
                while (true)
                {
                    int[] drawPoints = {106, 97, 102, 125, 157, 153, 171, 220, 320, 369, 495, 580, 658, 891, 1015, 1236, 1371,
                                        1587, 1826, 2047, 2216, 2574, 2988, 3373, 3933, 4242, 4504, 4471, 4295, 4032, 3583,
                                        3449, 3251, 2810, 2769, 2545, 2431, 2259, 2214, 2107, 2064, 2003, 2136, 2119, 2132,
                                        2303, 2355, 2432, 2504, 2659, 2711, 2693, 2839, 2939, 2954, 2935, 2909, 2913, 2950,
                                        2836, 2839, 2851, 2879, 2934, 2883, 2883, 2969, 2940, 3002, 3022, 3066, 3108, 3228,
                                        3184, 3316, 3286, 3408, 3321, 3454, 3335, 3521, 3492, 3529, 3463, 3467, 3517, 3516,
                                        3601, 3737, 3789,  3848, 4035, 4182, 4630, 4869, 5381, 5697, 6120, 6422, 6741, 6868,
                                        7183, 7352, 7465, 7487, 7399, 7384, 7174, 7120, 7108, 6900, 6779, 6465, 6275, 6179,
                                        5959, 5889, 5670, 5530, 5280, 5046, 5033, 4765, 4728, 4419, 4476, 4163, 4032, 3940,
                                        3789, 3661, 3536, 3375, 3246, 3063, 2967, 2825, 2720, 2638, 2484, 2360, 2318, 2211,
                                        2052, 2039, 1959, 1803, 1716, 1644, 340, 383, 432, 484, 645, 752, 864, 1187, 1398,
                                        1824, 2320, 2985, 3619, 4440, 5387, 6434, 7350, 8561, 9708, 10924, 12275, 13918, 15868,
                                        18260, 20565, 21977, 23022, 22843, 21674, 19854, 17876, 15913, 14653, 13091, 12190,
                                        11176, 10124, 9314, 8605, 7922, 7462, 6951, 6751, 6456, 6339, 6299, 6088, 6107, 5971,
                                        5845, 5806, 5716, 5761, 5581, 5505, 5327, 5072, 4824, 4727, 4528, 4388, 4192, 3943,
                                        3934, 3671, 3600, 3537, 3569, 3591, 3623, 3572, 3638, 3637, 3848, 3794, 3909, 3865,
                                        3899, 3850, 3765, 3669, 3641, 3702, 3721, 3686, 3658, 3587, 3649, 3764, 3921, 4204,
                                        4605, 5227, 6260, 7777, 9604, 12035, 14605, 17817, 21034, 24064, 26804, 29274, 31141,
                                        33138, 33945, 35052, 35564, 35739, 36071, 35498, 35001, 34656, 33900, 33338, 32600,
                                        31948, 31362, 30101, 29232, 28384, 27550, 27032, 25841, 25349, 24465, 23815, 23052,
                                        22188, 21406, 20704, 19863, 18942, 18476, 17658, 17023, 16280, 15666, 14960, 14458,
                                        13677, 13029, 12506, 12020, 11344, 10917, 10229, 9893, 9363, 8782, 542, 569, 690, 852,
                                        1007, 1210, 1390, 1829, 2311, 2927, 3722, 4532, 5646, 6826, 8067, 9597, 11121, 12783,
                                        14245, 16130, 17887, 20414, 23256, 26585, 29600, 32086, 33582, 33441, 31851, 29332,
                                        26424, 24064, 21986, 19824, 18614, 17304, 15840, 14583, 13497, 12819, 12158, 11650,
                                        11480, 11244, 11002, 10965, 10926, 11019, 10855, 10776, 10971, 10909, 10725, 10692,
                                        10679, 10536, 10227, 10167, 9973, 9548, 9492, 9235, 8984, 8881, 8800, 8752, 8683, 8871,
                                        8934, 9141, 9437, 9573, 9736, 10012, 10252, 10397, 10592, 10725, 10776, 10639, 10611,
                                        10567, 10453, 10492, 10602, 10450, 10484, 10541, 10576, 10921, 11579, 12270, 13869,
                                        15971, 18840, 22555, 27167, 31807, 37048, 41817, 46802, 50670, 53684, 55586, 57392,
                                        57482, 58715, 58573, 58626, 59112, 58842, 57980, 57963, 57619, 57579, 56937, 56285,
                                        55161, 53932, 52765, 51321, 49986, 48595, 47378, 46088, 44526, 43334, 41668, 40248,
                                        38895, 37014, 36189, 34471, 33405, 31918, 30878, 29460, 28407, 26798, 25883, 24912,
                                        23788, 22685, 21692, 20842, 19951, 18985, 18066, 17334, 16314, 1338, 1397, 1635, 1880,
                                        2312, 2714, 3315, 4228, 5264, 6602, 8115, 10297, 12375, 14982, 17963, 21430, 24570,
                                        27784, 31037, 34458, 38694, 43375, 48702, 54325, 57204, 57857, 58316, 58929, 58082,
                                        57925, 56360, 54214, 51607, 47884, 45712, 43413, 41092, 38533, 36920, 35670, 35213,
                                        34491, 34828, 35256, 35654, 36172, 37255, 38087, 39049, 39482, 40650, 41558, 42495,
                                        42798, 43767, 43935, 44314, 44761, 45765, 45836, 46885, 47032, 47414, 48181, 48315,
                                        50067, 50685, 52021, 52841, 54028, 54602, 56312, 56956, 57395, 58401, 57597, 58505,
                                        58831, 58788, 58820, 59202, 59382, 59546, 59130, 59859, 59443, 59465, 59861, 59321,
                                        59305, 59674, 60033, 60090, 60041, 60148, 59916, 59979, 60339, 60273, 60663, 60799,
                                        60375, 60361, 60221, 60650, 60306, 60533, 60513, 60503, 60768, 60590, 59760, 59768,
                                        59881, 60221, 59981, 60025, 59800, 59405, 58961, 58657, 59544, 58238, 57643, 57431,
                                        56103, 54781, 53657, 51456, 50047, 47930, 46483, 44327, 42889, 41006, 39476, 37978,
                                        36471, 34940, 33110, 32240, 30404, 29221, 28249, 27062, 26157, 24862, 23772, 23034,
                                        21860, 1506, 1611, 1862, 2098, 2560, 3043, 3727, 4644, 5870, 7450, 9162, 11328, 13926,
                                        16662, 20119, 23875, 27432, 31054, 34675, 38819, 42847, 48114, 53759, 56721, 58360,
                                        58492, 58797, 59272, 58602, 58786, 58019, 58121, 56804, 53282, 51493, 49169, 47009,
                                        44400, 42670, 40948, 40612, 39817, 40478, 41016, 41200, 42198, 43062, 44044, 45115,
                                        45899, 47631, 48290, 49150, 50076, 51254, 51218, 52062, 52364, 53442, 53974, 54976,
                                        55310, 55908, 56942, 56675, 57598, 58121, 58899, 58442, 58292, 58505, 59373, 59305,
                                        59369, 59924, 59056, 59744, 59846, 59664, 59788, 59930, 60048, 60283, 59987, 60599,
                                        60445, 60339, 60787, 60349, 60573, 60631, 60843, 60969, 60856, 60839, 60633, 60478,
                                        60906, 60665, 61006, 61009, 60544, 60400, 60244, 60672, 60284, 60487, 60375, 60381,
                                        60667, 60351, 59611, 59685, 59742, 60082, 59836, 59844, 59555, 59171, 58498, 58183,
                                        58797, 57379, 56521, 55534, 53861, 52500, 51329, 49004, 47567, 45739, 44257, 42174,
                                        40743, 39122, 37277, 36212, 34658, 33046, 31637, 30171, 28989, 27897, 26841, 25577,
                                        24805, 23572, 22695, 21748, 20490, 1344, 1492, 1694, 1970, 2221, 2682, 3120, 4083,
                                        5002, 6237, 7919, 9586, 11662, 14152, 17070, 19871, 23116, 26056, 29279, 32716, 36195,
                                        41102, 46441, 52321, 56282, 57387, 58096, 58592, 57777, 57413, 55712, 52970, 50384,
                                        46595, 44927, 43029, 40993, 38631, 37320, 36427, 35908, 35686, 36418, 37187, 38328,
                                        39361, 40433, 42085, 43166, 43836, 45600, 46893, 48013, 48747, 50012, 50225, 50918,
                                        51679, 52665, 53110, 54049, 54453, 54947, 56178, 56207, 56908, 57736, 58436, 58020,
                                        58032, 58279, 59228, 59130, 59219, 59808, 58968, 59616, 59737, 59444, 59603, 59758,
                                        59919, 60048, 59784, 60321, 60157, 60075, 60564, 60114, 60139, 60377, 60523, 60664,
                                        60675, 60627, 60374, 60272, 60558, 60398, 60719, 60815, 60304, 60180, 59947, 60422,
                                        60026, 60259, 60182, 60250, 60512, 60232, 59465, 59474, 59616, 59871, 59543, 59557,
                                        59236, 58669, 57749, 57188, 57373, 55849, 54260, 53596, 51592, 50261, 48592, 46649,
                                        45146, 43525, 42160, 40108, 38901, 37341, 35766, 34147, 32804, 31403, 30243, 28887,
                                        27592, 26576, 25390, 24011, 23503, 22131, 21415, 20676, 19471, 745, 783, 864, 960,
                                        1118, 1238, 1460, 1808, 2102, 2532, 3068, 3729, 4546, 5395, 6359, 7464, 8784, 9902,
                                        11083, 12326, 13869, 15867, 18163, 20959, 23512, 25840, 27239, 27603, 26555, 25122,
                                        23443, 21914, 20627, 19096, 18771, 18085, 17542, 17127, 16948, 16811, 17513, 17947,
                                        19268, 20660, 22232, 24425, 26516, 28374, 30821, 32626, 35257, 37290, 38934, 40376,
                                        41896, 43142, 43825, 44446, 45571, 45853, 47050, 47081, 47962, 48834, 48723, 49978,
                                        50776, 51759, 52093, 53075, 53656, 55079, 55667, 56118, 56966, 56478, 57466, 57921,
                                        57778, 57933, 58356, 58599, 58912, 58380, 59174, 58758, 58963, 59293, 58687, 58754,
                                        59103, 59448, 59516, 59371, 59531, 59011, 59353, 59420, 59070, 59772, 59723, 59211,
                                        58774, 58574, 59273, 58438, 58997, 58312, 58117, 57820, 56922, 55809, 54904, 53789,
                                        52774, 51674, 49996, 48774, 47319, 45672, 44461, 42897, 41874, 40508, 39497, 37668,
                                        36953, 35562, 34210, 33049, 31429, 30632, 29203, 28336, 26771, 25839, 24952, 23783,
                                        22783, 21791, 20839, 19843, 19061, 18515, 17459, 16736, 15992, 15315, 14681, 13736,
                                        354, 346, 371, 384, 408, 418, 436, 463, 500, 536, 622, 716, 758, 945, 1023, 1104, 1301,
                                        1423, 1536, 1705, 1855, 2152, 2362, 2822, 3192, 3589, 3736, 3761, 3738, 3615, 3486,
                                        3368, 3259, 3225, 3249, 3327, 3471, 3576, 3771, 4248, 4817, 5572, 6531, 7742, 9486,
                                        11346, 13843, 16285, 19402, 21383, 24634, 27041, 29256, 31527, 33324, 34649, 35577,
                                        36624, 37772, 37938, 38848, 38506, 39319, 39617, 39875, 40354, 40663, 41565, 41279,
                                        41382, 42082, 42705, 42714, 43170, 43335, 43736, 44154, 44330, 44356, 44262, 44363,
                                        44877, 44841, 44889, 45254, 44763, 45171, 45277, 45591, 45539, 45621, 45551, 45767,
                                        45382, 45823, 45397, 45197, 44882, 44227, 43725, 43339, 42535, 41899, 40937, 40482,
                                        39195, 38423, 37705, 36765, 35640, 34709, 33823, 32922, 31737, 30943, 30351, 28955,
                                        27941, 27565, 26492, 25595, 24759, 23960, 23262, 22769, 21647, 21055, 20061, 19571,
                                        19115, 18062, 17735, 16713, 16263, 15474, 14880, 14217, 13675, 13018, 12613, 11992,
                                        11354, 10887, 10520, 10027, 9433, 9185, 8659, 8238, 7731, 275, 318, 306, 330, 378, 371,
                                        346, 430, 452, 530, 584, 656, 750, 873, 908, 1076, 1168, 1301, 1456, 1627, 1771, 2033,
                                        2423, 2673, 3017, 3429, 3671, 3722, 3607, 3510, 3361, 3214, 3170, 3005, 3144, 3183,
                                        3231, 3460, 3589, 4094, 4651, 5352, 6335, 7613, 9102, 11154, 13123, 15715, 18169, 20548,
                                        23519, 25743, 28310, 29976, 31756, 32925, 33624, 34469, 35147, 35512, 36135, 36125, 36499,
                                        36800, 36416, 37001, 36921, 37543, 37282, 37431, 37510, 37964, 38149, 38086, 38047, 38315,
                                        38341, 38066, 38203, 37985, 37679, 37630, 37669, 37437, 37584, 37381, 37240, 37247, 37120,
                                        37516, 37426, 37144, 37263, 36976, 37266, 36643, 36404, 35836, 35516, 35229, 34621, 33948,
                                        33065, 32497, 31914, 31110, 30386, 29834, 28817, 28255, 27579, 26430, 25881, 25071, 24367,
                                        23796, 22953, 22299, 21421, 20836, 20159, 19531, 18990, 18145, 17593, 17116, 16663, 16010,
                                        15416, 15003, 14423, 13728, 13496, 12916, 12226, 11768, 11349, 10821, 10526, 9884, 9483,
                                        9017, 8694, 8388, 7817, 7493, 7192, 6959, 6500, 6099, 197, 165, 200, 210, 231, 256, 245,
                                        296, 319, 330, 382, 463, 509, 597, 699, 799, 856, 997, 1147, 1279, 1432, 1616, 1829, 2181,
                                        2499, 2779, 2968, 3086, 2969, 2913, 2728, 2560, 2450, 2443, 2532, 2439, 2587, 2721, 2832,
                                        3207, 3623, 4126, 4912, 5924, 7053, 8352, 9918, 11773, 13263, 15141, 16992, 18541, 19617,
                                        20939, 22105, 22215, 22594, 22768, 22879, 22778, 23539, 22713, 22758, 22518, 22203, 22106,
                                        22022, 21973, 21544, 21413, 21135, 20735, 20616, 20451, 19917, 19483, 19250, 18506, 18121,
                                        17479, 16966, 16590, 16194, 15914, 15321, 15017, 14938, 14656, 14391, 14303, 14028, 14051,
                                        14166, 13995, 14203, 14254, 14176, 14522, 14330, 14337, 14377, 14109, 14087, 13719, 13645,
                                        13094, 13038, 12572, 12454, 12066, 11703, 11296, 11058, 10770, 10334, 10153, 9716, 9449,
                                        9283, 8864, 8716, 8348, 8067, 7951, 7617, 7475, 7272, 7077, 6788, 6691, 6414, 6252, 6031,
                                        5850, 5615, 5321, 5179, 4980, 4691, 4486, 4271, 4050, 3875, 3766, 3499, 3362, 3246, 2980,
                                        2821, 2644, 80, 73, 106, 114, 130, 128, 107, 172, 179, 248, 285, 335, 398, 489, 596, 699,
                                        806, 925, 1063, 1197, 1283, 1557, 1732, 1999, 2268, 2465, 2615, 2643, 2659, 2416, 2238, 2176,
                                        1886, 1869, 1788, 1796, 1714, 1604, 1724, 1689, 1772, 1785, 2021, 2109, 2348, 2534, 2736, 2975,
                                        3252, 3455, 3651, 3859, 4008, 4134, 4301, 4342, 4436, 4324, 4397, 4384, 4557, 4457, 4644, 4665,
                                        4593, 4723, 4823, 4821, 4817, 4944, 4980, 5067, 5110, 5182, 5180, 5306, 5230, 5267, 5372, 5363,
                                        5308, 5285, 5436, 5315, 5283, 5321, 5497, 5380, 5527, 5449, 5479, 5558, 5653, 5716, 6002, 6146,
                                        6255, 6360, 6422, 6512, 6592, 6563, 6565, 6595, 6387, 6309, 6178, 6143, 6056, 5814, 5710, 5570,
                                        5346, 5211, 5044, 5018, 4790, 4618, 4599, 4272, 4208, 4027, 3931, 3880, 3758, 3568, 3453, 3350,
                                        3245, 3052, 2944, 2881, 2741, 2748, 2530, 2432, 2390, 2312, 2218, 2112, 1984, 1906, 1820, 1794,
                                        1661, 1622, 1557, 1456, 1373, 1301
                    };

                    foreach (var webSocketSession in webSocketSessions)
                    {
                        webSocketSession.Value.Send(JsonConvert.SerializeObject(drawPoints));
                        Thread.Sleep(1000);
                    }
                }
            });
            task.Start();
        }

        private void button2_Click(object sender, EventArgs e)
        {
            Application.Exit();
        }

        private void WsServer_NewSessionConnected(WebSocketSession session)
        {
            if (webSocketSessions.ContainsKey(session.SessionID))
                webSocketSessions[session.SessionID] = session;
            else
                webSocketSessions.Add(session.SessionID, session);
        }

        public void setFormConfig()
        {
            SetBrowserFeatureControlKey("FEATURE_BROWSER_EMULATION", fileName, GetBrowserEmulationMode());
            SetBrowserFeatureControlKey("FEATURE_AJAX_CONNECTIONEVENTS", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_ENABLE_CLIPCHILDREN_OPTIMIZATION", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_MANAGE_SCRIPT_CIRCULAR_REFS", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_DOMSTORAGE ", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_GPU_RENDERING ", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_IVIEWOBJECTDRAW_DMLT9_WITH_GDI ", fileName, 0);
            SetBrowserFeatureControlKey("FEATURE_DISABLE_LEGACY_COMPRESSION", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_LOCALMACHINE_LOCKDOWN", fileName, 0);
            SetBrowserFeatureControlKey("FEATURE_BLOCK_LMZ_OBJECT", fileName, 0);
            SetBrowserFeatureControlKey("FEATURE_BLOCK_LMZ_SCRIPT", fileName, 0);
            SetBrowserFeatureControlKey("FEATURE_DISABLE_NAVIGATION_SOUNDS", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_SCRIPTURL_MITIGATION", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_SPELLCHECKING", fileName, 0);
            SetBrowserFeatureControlKey("FEATURE_STATUS_BAR_THROTTLING", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_TABBED_BROWSING", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_VALIDATE_NAVIGATE_URL", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_WEBOC_DOCUMENT_ZOOM", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_WEBOC_POPUPMANAGEMENT", fileName, 0);
            SetBrowserFeatureControlKey("FEATURE_WEBOC_MOVESIZECHILD", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_ADDON_MANAGEMENT", fileName, 0);
            SetBrowserFeatureControlKey("FEATURE_WEBSOCKET", fileName, 1);
            SetBrowserFeatureControlKey("FEATURE_WINDOW_RESTRICTIONS ", fileName, 0);
            SetBrowserFeatureControlKey("FEATURE_XMLHTTP", fileName, 1);
        }

        private void SetBrowserFeatureControlKey(string feature, string appName, uint value)
        {
            using (var key = Registry.CurrentUser.CreateSubKey(
                String.Concat(@"Software\Microsoft\Internet Explorer\Main\FeatureControl\", feature),
                RegistryKeyPermissionCheck.ReadWriteSubTree))
            {
                key.SetValue(appName, (UInt32)value, RegistryValueKind.DWord);
            }
        }

        private UInt32 GetBrowserEmulationMode()
        {
            int browserVersion = 7;
            using (var ieKey = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\Microsoft\Internet Explorer",
                RegistryKeyPermissionCheck.ReadSubTree, System.Security.AccessControl.RegistryRights.QueryValues))
            {
                var version = ieKey.GetValue("svcVersion");
                if (null == version)
                {
                    version = ieKey.GetValue("Version");
                    if (null == version)
                        throw new ApplicationException("Microsoft Internet Explorer is required!");
                }
                int.TryParse(version.ToString().Split('.')[0], out browserVersion);
            }

            UInt32 mode = 11000;
            switch (browserVersion)
            {
                case 7:
                    mode = 7000;
                    break;
                case 8:
                    mode = 8000;
                    break;
                case 9:
                    mode = 9000;
                    break;
                case 10:
                    mode = 10000;
                    break;
                default:
                    break;
            }

            return mode;
        }
    }
}
